<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Dia Dia é meu</title>
	<style>
		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0
		}

		body {
			font-family: Verdana, sans-serif;
			overflow: hidden;
			background: #1E22A8
		}

		#galeria {
			position: relative;
			width: 100vw;
			height: 100vh;
			text-align: center
		}

		#galeria img,
		#galeria iframe {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			border: none;
			width: 100%;
			height: 100%;
			max-width: 98%;
			max-height: 98%;
			object-fit: contain;
		}

		#barra-contagem {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 8px;
			background: rgba(0, 0, 0, .1);
			z-index: 9999;
			overflow: hidden
		}

		#barra {
			height: 100%;
			width: 0;
			background: #4caf50
		}

		#spanRelogio {
			position: fixed;
			bottom: 10px;
			left: 10px;
			padding: 8px 12px;
			background: rgba(0, 0, 0, .6);
			color: white;
			font-size: 14px;
			border-radius: 4px;
			z-index: 99999
		}

		#status {
			position: fixed;
			top: 40%;
			width: 100%;
			text-align: center;
			color: white;
			font-size: 16px;
			background: rgba(0, 0, 0, .6);
			padding: 10px
		}

		@keyframes barraAnim {
			from {
				width: 0%;
			}

			to {
				width: 100%;
			}
		}
	</style>
</head>

<body>

	<span id="spanRelogio"></span>
	<div id="galeria">
		<div id="status">Carregando slides...</div>
	</div>
	<div id="barra-contagem">
		<div id="barra"></div>
	</div>

	<script>
		const urlJSON = "https://intcicopal.github.io/diadia/diadia.json";
		const galeria = document.getElementById("galeria");
		const barra = document.getElementById("barra");
		let slides = [], tempos = [], slideIndex = 0, relogioTimer, barraTimer;

		function criarElemento(tag, src) {
			const el = document.createElement(tag);
			el.src = src;
			// el.className = "mySlides";
			el.style.zIndex = 1;
			if (tag === "img") el.onerror = () => el.style.zIndex = 1;
			galeria.appendChild(el);
			return el;
		}

		function carregarSlides(data) {
			galeria.innerHTML = "";
			slides = [];
			tempos = [];
			let idx = 0;
			if (data.imagens) data.imagens.forEach(item => {
				slides.push(criarElemento("img", `https://intcicopal.github.io/diadia/src/${item.nome}`));
				tempos[idx++] = (item.tempo || 5) * 1000;
			});
			if (data.links) data.links.forEach(item => {
				const src = `https://app.powerbi.com/reportEmbed?reportId=${item.reportId}&autoAuth=true&ctid=${item.ctid}&pageName=${item.pageName}&navContentPaneEnabled=false&filterPaneEnabled=false&actionBarEnabled=false`;
				slides.push(criarElemento("iframe", src));
				tempos[idx++] = (item.tempo || 10) * 1000;
			});
			if (slides.length > 0) {
				slideIndex = 0;
				mostrarSlide();
				document.getElementById("status").style.display = "none";
			} else galeria.innerHTML = "<span style='color:white'>Nenhum slide encontrado no JSON.</span>";
		}

		function mostrarSlide() {
			slides.forEach((s, i) => s.style.zIndex = 1);
			slides[slideIndex].style.zIndex = 9998;
			iniciarBarra(tempos[slideIndex]);
			slideIndex = (slideIndex + 1) % slides.length;
			setTimeout(mostrarSlide, tempos[slideIndex]);
		}

		let barraAnimFrame;

		function iniciarBarra(duracao) {
			const barra = document.getElementById("barra");
			barra.style.animation = "none"; // reset
			barra.offsetHeight; // força reflow
			barra.style.animation = `barraAnim ${duracao / 1000}s linear forwards`;
		}

		function relogio() {
			const agora = new Date();
			const minutos = agora.getMinutes();
			const segundos = agora.getSeconds();

			// Encontrar próximo múltiplo de 15 (15, 30, 45, 60)
			let proximoBloco = Math.ceil((minutos + 1) / 15) * 15;

			// Se passar de 60, volta para 60 (tratando como "fim da hora")
			if (proximoBloco > 60) {
				proximoBloco = 60;
			}

			// Calcular tempo restante
			let minRest = proximoBloco - minutos - 1;
			let segRest = 59 - segundos;

			// Quando chegar em 00:00 dispara reload
			if (minRest < 0) {
				minRest = 0;
				segRest = 0;
				location.reload();
				return;
			}

			document.getElementById("spanRelogio").textContent =
				`Próxima Atualização em: ${String(minRest).padStart(2, '0')}:${String(segRest).padStart(2, '0')}`;
		}

		// Atualiza relógio a cada segundo
		relogioTimer = setInterval(relogio, 1000);

		// Inicialização
		fetch(urlJSON)
			.then(r => r.ok ? r.json() : Promise.reject(r.status))
			.then(data => carregarSlides(data))
			.catch(err => {
				console.error("Erro JSON:", err);
				document.getElementById("status").textContent = "Erro ao carregar dados. Tentando novamente...";
				setTimeout(() => location.reload(), 5000);
			});

	</script>

</body>

</html>
