<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Dia Dia é meu</title>
	<link rel="shortcut icon"
		href="https://static.wixstatic.com/media/7bddc8_b0a20b809f8647898991ef927d5203d8%7Emv2.png/v1/fill/w_192%2Ch_192%2Clg_1%2Cusm_0.66_1.00_0.01/7bddc8_b0a20b809f8647898991ef927d5203d8%7Emv2.png">
	<style>
		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			font-family: Verdana, sans-serif;
			overflow: hidden;
			background-color: #1E22A8;
		}

		.mySlides {
			display: block;
		}

		.mySlide.active {
			opacity: 1;
			z-index: 1;
		}

		#galerias {
			position: relative;
			width: 100vw;
			height: 100vh;
			text-align: center;
		}

		#galeria img,
		#galeria iframe {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			border: none;
			width: 100%;
			height: 100%;
			max-width: 98%;
			max-height: 98%;
			object-fit: contain;
		}

		#barra-contagem {
			position: fixed;
			/* --duration: 5s; */
			top: 0;
			left: 0;
			width: 100%;
			height: 8px;
			background-color: rgba(0, 0, 0, 0.1);
			z-index: 9999;
			overflow: hidden;
		}

		#barra {
			height: 100%;
			width: 100%;
			background-color: #4caf50;
			animation: fill var(--duration) linear;
			transform-origin: left;
			transform: scaleX(0);
			transition: transform linear;
		}

		#spanRelogio {
			position: fixed;
			bottom: 10px;
			left: 10px;
			padding: 8px 12px;
			background-color: rgba(0, 0, 0, 0.6);
			color: white;
			font-size: 14px;
			border-radius: 4px;
			z-index: 99999;
		}

		#status {
			position: fixed;
			top: 40%;
			width: 100%;
			text-align: center;
			color: white;
			font-size: 16px;
			background: rgba(0, 0, 0, 0.6);
			padding: 10px;
		}
	</style>
</head>

<body>

	<span id="spanRelogio">Próxima Atualização em: </span>
	<div id="galeria">
		<div id="status">Carregando slides...</div>
	</div>
	<div id="barra-contagem">
		<div id="barra"></div>
	</div>


	<script>

		function LoadImg() {
			const urlJSON = "https://intcicopal.github.io/diadia/diadia.json";
			fetch(urlJSON)
				.then(response => {
					if (!response.ok) throw new Error(`HTTP status ${response.status}`);
					return response.json();
				})
				.then(data => {
					const galeria = document.getElementById("galeria");
					galeria.innerHTML = "";
					tempopp = [];
					slideIndex = 0;
					var indexTT = 0;
					var slidesExist = false;

					// Processar imagens
					if (data.imagens && Array.isArray(data.imagens)) {
						data.imagens.forEach(function (item) {
							const img = document.createElement('img');
							img.className = "mySlides";
							img.src = `https://intcicopal.github.io/diadia/src/${item.nome}`;
							img.onerror = function () {
								console.error("Falha ao carregar imagem:", img.src);
								this.style.display = "none";
							};
							galeria.appendChild(img);
							tempopp[indexTT++] = item.tempo * 1000;
							slidesExist = true;
						});
					}

					// Processar links (exemplo: Power BI embed)
					if (data.links && Array.isArray(data.links)) {
						data.links.forEach(function (item) {
							const iframe = document.createElement('iframe');
							iframe.className = "mySlides";
							iframe.allowFullscreen = true;
							iframe.src = `https://app.powerbi.com/reportEmbed?reportId=${item.reportId}&autoAuth=true&ctid=${item.ctid}&pageName=${item.pageName}&navContentPaneEnabled=false&filterPaneEnabled=false&actionBarEnabled=false`;
							// iframe.src = https://app.powerbi.com/reportEmbed?reportId=${item.reportId}&autoAuth=true&ctid=${item.ctid}&pageName=${item.pageName}&navContentPaneEnabled=false;
							galeria.appendChild(iframe);
							tempopp[indexTT++] = item.tempo * 1000;
							slidesExist = true;
						});
					}

					if (slidesExist) {
						showSlides();
					} else {
						galeria.innerHTML = "<span style='color:white'>Nenhum slide encontrado no JSON.</span>";
					}
				})
				.catch(error => {
					console.error('Erro ao carregar JSON:', error);
					document.getElementById("status").innerHTML = "Erro ao carregar dados. Tentando novamente...";
					setTimeout(() => {
						// location.href = location.href.split('?')[0] + '?nocache=' + new Date().getTime();
						location.reload();
					}, 5000);
				});
		}

		function showSlides() {
			var slides = document.getElementsByClassName("mySlides");

			if (slides.length === 0) {
				console.warn("Nenhum slide para exibir.");
				return;
			}

			for (var i = 0; i < slides.length; i++) {
				slides[i].style.zIndex = 1
			}

			if (slideIndex >= slides.length) {
				slideIndex = 0;
			}

			slides[slideIndex].style.zIndex = 9999;
			document.getElementById('barra').style.transition = 'none';
			document.getElementById('barra').style.transform = 'scaleX(0)';
			// Força reflow para reiniciar animação
			void document.getElementById('barra').offsetWidth;
			document.getElementById('barra').style.transition = `transform ${tempopp[slideIndex]}ms linear`;
			document.getElementById('barra').style.transform = 'scaleX(1)';


			setTimeout(showSlides, tempopp[slideIndex]);
			slideIndex++;
		}

		function syncCountdown() {
			const el = document.getElementById("spanRelogio");

			const now = new Date();
			const min = now.getMinutes();

			// próximo múltiplo de 15 (00, 15, 30, 45)
			const next = new Date(now);
			next.setMinutes(Math.ceil((min + 1) / 30) * 30, 0, 0);

			// agenda reload único
			setTimeout(() => {
				location.href = location.pathname + "?nocache=" + Date.now();
			}, next - now);

			function updateClock() {
				const diffSec = Math.floor((next - new Date()) / 1000);

				if (diffSec <= 0) return; // já vai recarregar

				const mm = String(Math.floor(diffSec / 60)).padStart(2, "0");
				const ss = String(diffSec % 60).padStart(2, "0");
				el.textContent = `Próxima Atualização em: ${mm}:${ss}`;

				// sincroniza para disparar exatamente no próximo segundo
				const delay = 1000 - (Date.now() % 1000);
				setTimeout(updateClock, delay);
			}

			updateClock();
		}

		LoadImg()
		syncCountdown();
	</script>

</body>

</html>
